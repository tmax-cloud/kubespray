---
- name: HyperRegistry | Wait up for running Core service
  uri:
    url: "https://core.{{ hyperregistry_release_name }}.{{ custom_domain_name }}/api/v2.0/health"
    validate_certs: no
  register: core_health_result
  until: core_health_result.status == 200
  retries: 60
  delay: 5

- name: HyperRegistry | Retreive harbor CA
  shell: kubectl get secret hyperregistry-harbor-ingress -n hyperregistry -o jsonpath="{.data['ca\.crt']}" | base64 --decode > ca.crt

- name: HyperRegistry | Trust harbor CA
  shell: |
    cp ca.crt "/usr/local/share/ca-certificates/core.{{ hyperregistry_release_name }}.{{ custom_domain_name }}.crt"
    update-ca-certificates
    service crio restart

- name: HyperRegistry | Wait up for running Core service again
  uri:
    url: "https://core.{{ hyperregistry_release_name }}.{{ custom_domain_name }}/api/v2.0/health"
    validate_certs: no
  register: core_health_result
  until: core_health_result.status == 200
  retries: 60
  delay: 5

- name: HyperRegistry | Copy images from private registry
  script: dup.sh "{{ registry_host }}" "core.{{ hyperregistry_release_name }}.{{ custom_domain_name }}"
