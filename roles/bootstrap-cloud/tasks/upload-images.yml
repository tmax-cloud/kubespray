---
- name: Install required packages
  become: true
  yum:
    name: "{{ item }}"
    state: "present"
  with_items:
    - "skopeo"
  when: ansible_os_family == "RedHat"

- name: Install required packages
  apt:
     name: "{{ item }}"
     state: "present"
  with_items:
    - "skopeo"
  when: ansible_os_family == "Debian"

- name: HyperRegistry | Wait up for running Core service
  uri:
    url: "https://{{ hyperregistry_release_name }}.{{ custom_domain_name }}/api/v2.0/health"
    validate_certs: no
  register: core_health_result
  until: core_health_result.status == 200
  retries: 60
  delay: 10

- name: HyperRegistry | Login harbor
  become: true
  shell: |
    echo admin | skopeo login "{{ hyperregistry_release_name }}.{{ custom_domain_name }}:{{ hyperregistry_ingress_nginx_port }}" \
      -u admin --password-stdin \
      --cert-dir /etc/pki/ca-trust/source/anchors
  when: '''ID="centos"'' in os_release.stdout_lines or ''ID="ubuntu"'' in os_release.stdout_lines or ''ID="amzn"'' in os_release.stdout_lines'

- name: HyperRegistry | Login harbor
  become: true
  shell: |
    echo admin | skopeo login "{{ hyperregistry_release_name }}.{{ custom_domain_name }}:{{ hyperregistry_ingress_nginx_port }}" \
      -u admin --password-stdin \
      --cert-dir /usr/share/pki/ca-trust-source/anchors/
  when: '''ID="pl"'' in os_release.stdout_lines or ''ID="rhel"'' in os_release.stdout_lines'

- name: HyperRegistry | Copy images
  become: true
  shell: |
    skopeo copy --src-tls-verify=false --dest-cert-dir=/etc/pki/ca-trust/source/anchors \
      "docker://{{ registry_host }}/{{ item }}" "docker://{{ hyperregistry_release_name }}.{{ custom_domain_name }}:{{ hyperregistry_ingress_nginx_port }}/library/{{ item }}"
  loop: "{{ lookup('file', 'files/images.txt').splitlines() }}"
  when: '''ID="centos"'' in os_release.stdout_lines or ''ID="ubuntu"'' in os_release.stdout_lines or ''ID="amzn"'' in os_release.stdout_lines'

- name: HyperRegistry | Copy images
  become: true
  shell: |
    skopeo copy --src-tls-verify=false --dest-cert-dir=/usr/share/pki/ca-trust-source/anchors \
      "docker://{{ registry_host }}/{{ item }}" "docker://{{ hyperregistry_release_name }}.{{ custom_domain_name }}:{{ hyperregistry_ingress_nginx_port }}/library/{{ item }}"
  loop: "{{ lookup('file', 'files/images.txt').splitlines() }}"
  when: '''ID="pl"'' in os_release.stdout_lines or ''ID="rhel"'' in os_release.stdout_lines'
