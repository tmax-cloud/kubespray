#!/bin/bash
pip3 install fnvhash

# Get gitlab ingress host address
GITLAB_INGRESS_HOST=$(kubectl get ingress {{ APP_NAME }}-ingress -n {{ NAMESPACE }} -o jsonpath="{.spec.rules[0].host}")

# Set Env
REPO_URL=https://$GITLAB_INGRESS_HOST/root/{{ REPO_NAME }}.git
USERNAME="root"
PASSWORD={{ GITLAB_PASSWORD }}
SECRET_MANIFEST="argocd-repo-secret.yml"

# Generate repository secret
SECRET_NAME=`python3 argocd-gen-secret-name.py $REPO_URL`

# Encode base64
BASE64_REPO_URL=$(echo $(echo -n $REPO_URL | base64) | tr -d ' ')
BASE64_USERNAME=$(echo $(echo -n $USERNAME | base64) | tr -d ' ')
BASE64_PASSWORD=$(echo $(echo -n $PASSWORD | base64) | tr -d ' ')

# Get gitlab tls key
GITLAB_TLS_CRT=$(kubectl get secret gitlab-tls -n {{ NAMESPACE }} -o jsonpath="{.data.tls\\.crt}")

# Replace vars
sed -i "s|\@secret_name|${SECRET_NAME}|g" ${SECRET_MANIFEST}
sed -i "s|\@repo_url|${BASE64_REPO_URL}|g" ${SECRET_MANIFEST}
sed -i "s|\@username|${BASE64_USERNAME}|g" ${SECRET_MANIFEST}
sed -i "s|\@password|${BASE64_PASSWORD}|g" ${SECRET_MANIFEST}
sed -i "s|\@tls_client_cert_key|${GITLAB_TLS_CRT}|g" ${SECRET_MANIFEST}

# Create Secret
kubectl apply -f $SECRET_MANIFEST
